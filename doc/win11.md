# Windows 11 の環境構築手順

ここでは以下の流れで説明していきます。

1. Windows Subsystem for Linux 2 のセットアップ
2. Windows Subsystem for Linux 2 で Ubuntu のセットアップ
3. サンプルコードお試し環境のダウンロード
4. Docker Desktop のインストール
5. Visual Studio Code の設定
6. サンプルコードお試し環境の利用方法
7. 書籍内のサンプルコードの実行方法

なお、以下の環境で確認した手順であり、エディション/バージョンによりメニューの位置等が違う可能性があります。

- エディション: Windows 11 Home
- バージョン: 23H2

## Windows Subsystem for Linux2 のセットアップ

Windows Subsystem for Linux 2 (これ以降 WSL2) を動作させるために、機能の有効化から行います。

- スタートメニューを右クリックして表示されるメニューから「設定」を選択
- 左メニューの「システム」を選択し、「オプション機能」を選択
- 関連設定にある「Windowsのその他の機能」を選択
- 「Windowsの機能の有効化または無効化」というポップアップが表示されるので、以下のものにチェックを入れて「OK」ボタンを押す
  - Linux 用 Windowsサブシステム
  - 仮想マシン プラットフォーム
- インストールが始まるのでそれが完了するまで待つ
- インストールが終わると再起動するように促されるので「今すぐ再起動」を選択し、再起動を行う

ここまでで、機能の有効化が完了したので、Linux カーネル更新プログラムパッケージを入手し、WSL2 向けのカーネルの更新を行います。

Linux カーネル更新プログラムは以下のURLからダウンロードできます。

- https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi

ダウンロードが完了したら、ダウンロードした msi ファイルを実行します。管理者特権のアクセス許可を求めるメッセージが表示されますので、「はい」を選択して、インストールしてください。

ここまで完了したら、以下の手順で WSL2 を規定のバージョンとして設定します。

1. タスクバー(Windowsの最下部に表示されているメニューボタンやアイコンが並んでいるバー)の検索窓に「PowerShell」と入力して、PowerShell を実行
2. 次のコマンドを入力して実行

```Powershell
wsl --set-default-version 2
```

これにより、WSL2 が利用可能となりました。

## WSL2 で Ubuntu のセットアップ

WSL2 が利用可能となったので、WSL2上で動作する Linux 環境をインストールします。

1. Microsoft Store を起動
2. 検索窓に「Ubuntu」と入力
3. 複数のバージョンが表示されるので、一番新しい LTS バージョンをインストール（2024/11月時点では Ubuntu 24.04 LTS が最新)
4. (もしインストールしていない場合は) 検索窓に「Terminal」と入力し、表示された「Windows Terminal」もインストール
5. Windows Terminal がインストールできたら、Microsoft Storeの表示が「入手」から「開く」に変わるので、「開く」を選択
6. タスクバーに表示された Windows Terminal に対して右クリックを行い、「タスクバーにピン留めする」を選択しておくと、今後 Windows Terminal を開くのが簡単になるのでおすすめ
7. Windows Termnail の上部にある + の横にある下向きの矢印のようなメニューを開くと、いくつかの項目が表示されるのでそこならインストールした Ubuntu のバージョンを選択する
8. ここで何らかのコマンドを実行を促される場合はその指示に従う

上記の手順で WSL2 上の Ubuntu 環境がいつでも利用可能となりました。

WSL2 上の Ubuntu 環境の2回目以降の起動は次のようにしてください。

1. タスクバーにピン留めした Windows Termnal を起動
2. Termnal 上部のメニューからインストールした Ubuntu を起動
3. (初回のみ) 利用する際のユーザー名とパスワードを聞かれるので入力してセットアップ完了する

Ubuntu に関して、複数のバージョンをインストールしている場合は、バージョン毎に別の環境になりますので、どの環境を使うかを決めておきましょう。

Ubuntu 環境を終了するには Windows Terminal を閉じるだけです。

## サンプルコードお試し環境のダウンロード

WSL2 のセットアップが完了したので、一旦このリポジトリで配布しているサンプルコードのお試し環境のダウンロードを行います。

まず、WSL2 上の Ubuntu 環境を起動します。起動方法を忘れた方は少し前の読み返してください。

起動後まずは、いくつかのパッケージのインストールを行います。

Ubuntu 上で以下のように入力してください。入力すると初回セットアップ時に設定したユーザのパスワードの入力になるので、そちらを入力してください。

```sh
sudo apt install -y git make
```

これによって、今回利用する git コマンドと make コマンドがインストールされます。

次に git の設定を行います。git で設定しておくべきものはいくつかありますが、最低限のものとして以下のものを設定しておきましょう。

```sh
git config --system user.name "名前"
git config --system user.email "メールアドレス"
```

上記の「名前」と「メールアドレス」の部分は自分のものに置き換えて設定してください。

git の設定がここまですんだら、以下のコマンドを入力して、サンプルコードお試し環境のダウンロードを行います。

```
mkdir -p ~/src/github.com/php-tech-master24
cd ~/src/github.com/php-tech-master24
git clone https://github.com/php-tech-master24/devenv.git
```

サンプルコードお試し環境の実際の利用方法は後ほど説明します。

## Docker Desktop のインストール

次は Docker の実行環境のセットアップになります。

Docker のウェブサイトから Docker Desktop をダウンロードします。以下のURLの「Download Docker Desktop」をクリックすると、対応OSとCPUアーキテクチャーの選択肢がでるので、「Download for Windows - AMD64」を選択します。（Intel/AMD以外のCPUのPCを利用している場合はご利用のCPUに合わせたものをダウンロードしてください）

- https://www.docker.com/get-started/

ダウンロードが完了したら、ダウンロードしたインストール用のファイルを実行し、インストールを行ってください。

インストール中に選択肢がでますが、ご利用のPCの状況に合わせてチェックを外してください。（通常はチェックが入ったままで構いません）

途中、WSL2関連の設定の選択肢が出た場合は、インストールしたUbuntuのバージョンを選択しておいてください。

インストールの流れが一通り進んだら、PCの再起動をすることを促されるので、再起動してインストールを完了してください。

## Visual Studio Code の設定

WSL2 および Docker のセットアップが完了したので、Visual Studio Code（これ以降 VS Code）で WSL2 上のファイルを編集する準備を行います。

VS Code の入手がまだの方は、まずは入手から行ってください。

以下のURLの「Download for Windows」をクリックすると、インストール用のファイルがダウンロードされるので、それを実行して VS Code のインストールを行ってください。

- https://code.visualstudio.com/

VS Code には Extension という機能を拡張する機構が備わっており、いくつかの Extension を入れておきましょう。

- VS Code を起動
- VS Code の左に並んだアイコンの四角が4つあって、一つだけ飛び出したようなアイコンをクリックします
- 検索窓に以下のものを入力して、いくつかの Extension をインストールしておきましょう
  - Japanese Language Pack for Visual Studio Code
  - PHP Intelephense
  - Docker
  - WSL

上記のものを入れておくとメニューの日本語化ができ、PHPのコードの入力支援、Dockerサポート、そして WSL2 上のファイル操作ができるようになります。

では、VS Code からサンプルコードお試し環境のファイルを編集できるようにしてみましょう。

- VS Code を起動
- VS Code の左に並んだアイコンのモニターの右下に丸がついたようなアイコン（リモートエクスプローラー）をクリックします
- WSL ターゲットにセットアップした Ubuntu のバージョンが表示されているので、それにマウスの合わせると2つアイコンが表示されるので、左側の「現在のウィンドウで接続する」を選択
- 一番上のアイコン（エクスプローラー）をクリックすると、「リモートに接続しました。」という状態になっているので、「フォルダーを開く」をクリック
- そうするとVS Code上部がフォルダ選択モードになるので、サンプルコードお試し環境をセットアップした以下のフォルダを選択し、「OK」をクリックする
  - src/github.com/php-tech-master24/devenv

初回のみ「このフォルダー内のファイルの作成者を信頼しますか？」という確認が入るので、「はい、作成者を信頼します」を選択しましょう。

ここまでの作業をすることにより、リモートエクスプローラーからいつでもサンプルコードお試し環境の編集ができるようになりました。

## サンプルコードお試し環境の利用方法

サンプルコードお試し環境の利用方法を説明します。

### 環境の起動方法

起動方法は以下の手順になります。

- Docker Desktop を起動
- WSL2 上の Ubuntu 環境を起動
- サンプルコードお試し環境のフォルダに移動

```sh
cd ~/src/github.com/php-tech-master24/devenv
```

- 以下のコマンドを実行し環境を起動

```sh
make up
```

初回起動時のみ Docker build が実行されるため、時間がかかります。

### コマンド実行環境への接続

環境が起動している状態で、以下の手順を行うとコマンド実行環境へ接続できます。

```sh 
make php-cli
```

上記を実行すると、コマンドが入力できる状態になります。（注: root@ の後ろの文字列は毎回変わります）

```sh
root@e7c45759d228:/var/www/html#
```

書籍内で以下の記述になっているものは以下のように置き換えて実行してください。

#### 書籍内の記述

```sh
$ vendor/bin/phpunit --version
```

#### お試し環境

```sh
root@e7c45759d228:/var/www/html# vendor/bin/phpunit --version
```

### 環境の終了方法

環境が起動している状態で、以下の手順を行うと環境が終了します。

```sh
make down
```

## 書籍内のサンプルコードの実行方法

最後に書籍内に記載されているサンプルコードの実行方法を説明します。

最初にお試し環境の起動を行います。

```sh
make up
```

次にコマンド実行環境に接続します。

```sh
make php-cli
```

ここまで実行しておいて、VS Code でサンプルコードお試し環境の app フォルダ以下に書籍に記載されているコードを入力します。

例えば、3章に書かれている最初のサンプルコードを試したい場合は以下のようなフォルダおよびファイルをつくって入力してください。

- app/chapter03/03-01_array1.php

サンプルファイルが入力できたら次のようにすれば実行できます。(実行環境上では app フォルダの指定は必要ありません)

```sh
root@e7c45759d228:/var/www/html# php chapter03/03-01_array1.php
```

お試しが一通り完了したら、お試し環境を終了しておきましょう。

```sh
make down
```